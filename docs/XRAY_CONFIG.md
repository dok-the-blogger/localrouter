# Xray Configuration Strategy

Этот документ описывает принципы построения конфигурации Xray (`opt/etc/xray/config.json`) в данном проекте.

## Архитектура маршрутизации

Конфигурация разработана с учетом специфики работы на роутере Asus (Asuswrt-Merlin + Entware) и направлена на:
1.  Выборочный обход блокировок.
2.  Блокировку нежелательного контента (реклама, трекеры).
3.  Оптимизацию маршрутов для разных сервисов.

### Правила маршрутизации (`routing.rules`)

Порядок правил в `routing.rules` **критически важен**, так как Xray обрабатывает их сверху вниз и останавливается на первом совпадении.

1.  **Блокировка рекламы (Ad-Blocking)**
    *   **Правило:** `domain: geosite:category-ads-all` -> `block`
    *   **Приоритет:** Самый высокий (1-е место).
    *   **Описание:** Это правило отсекает рекламные и трекинговые домены еще до того, как они будут проверены другими правилами или отправлены на резолвинг. Это экономит ресурсы и защищает устройства в сети.
    *   **Outbound:** `block` (протокол `blackhole`).

2.  **Локальный трафик (Local Network)**
    *   **Правило:** `ip: geoip:private` -> `direct`
    *   **Приоритет:** 2-е место.
    *   **Описание:** Трафик внутри локальной сети (192.168.x.x, 10.x.x.x и т.д.) должен идти напрямую, минуя прокси.

3.  **Специальные маршруты (Meta/Facebook/Instagram)**
    *   **Правило:** IP/Domain списки Meta -> `proxy-ca`
    *   **Описание:** Для сервисов Meta используется отдельный outbound `proxy-ca` (обычно VLESS или Shadowsocks на сервере с хорошим UDP), так как они чувствительны к качеству соединения (особенно QUIC/UDP).

4.  **Остальной трафик**
    *   Если трафик не попал ни под одно правило, он уходит в `outbound` по умолчанию (первый в списке `outbounds`).

### Исходящие соединения (`outbounds`)

1.  **Основной прокси (Default)**
    *   Первый элемент массива. Сюда попадает весь трафик, не отфильтрованный правилами маршрутизации.

2.  **Дополнительные прокси (`proxy-ca`, `proxy-do` и др.)**
    *   Используются для специфических маршрутов, заданных в `routing.rules`.

3.  **Blackhole (`block`)**
    *   **Протокол:** `blackhole`
    *   **Расположение:** Строго в конце списка.
    *   **Описание:** Используется для "сжигания" нежелательного трафика. Важно, чтобы этот outbound не оказался первым, иначе он станет дефолтным и "сломает" интернет.
